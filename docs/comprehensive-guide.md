# Comprehensive Guide: Building an MCP Server with Cloudflare Workers

This documentation covers the complete process of setting up a Model Context Protocol (MCP) server using Cloudflare Workers, from initial setup to deployment and integration with Claude Desktop.

## Table of Contents

1. [Prerequisites](#1-prerequisites)
2. [Project Setup](#2-project-setup)
3. [Configuring the MCP Server](#3-configuring-the-mcp-server)
4. [API Token Configuration](#4-api-token-configuration)
5. [Deployment](#5-deployment)
6. [Claude Desktop Integration](#6-claude-desktop-integration)
7. [Testing Your MCP Server](#7-testing-your-mcp-server)
8. [Extending Your MCP Server](#8-extending-your-mcp-server)
9. [Common Issues and Troubleshooting](#9-common-issues-and-troubleshooting)

## 1. Prerequisites

Before starting, ensure you have:

- **Node.js and npm** installed (version 16.x or higher recommended)
- **A Cloudflare account** with access to the Workers service
- **Claude Desktop** application installed (for testing the MCP integration)
- **Terminal/Command Line** access

## 2. Project Setup

### 2.1. Create a new project directory

```bash
# Create and navigate to a new directory
mkdir my-mcp-server
cd my-mcp-server
```

### 2.2. Initialize a new Cloudflare Worker project

```bash
# Install Wrangler globally (optional)
npm install -g wrangler

# Initialize a new Cloudflare Worker project
npx create-cloudflare@latest my-mcp-worker
cd my-mcp-worker
```

When prompted, select the following options:
- Hello World example
- Worker (TypeScript)
- No (to deploying right away)

### 2.3. Install the workers-mcp package

```bash
npm install workers-mcp --save-dev
```

## 3. Configuring the MCP Server

### 3.1. Run the setup command

```bash
npx workers-mcp setup
```

This guided installation will:
- Add the documentation generation step to your deploy script
- Generate a shared secret for authentication
- Update your source files to support MCP

### 3.2. Understanding the generated code

The setup creates or modifies `src/index.ts` to look like this:

```typescript
import { WorkerEntrypoint } from 'cloudflare:workers'
import { ProxyToSelf } from 'workers-mcp'

// Define interfaces for service methods (follows Interface Segregation Principle)
interface GreetingService {
  sayHello(name: string): string;
}

interface StringManipulationService {
  reverseString(input: string): string;
}

// Worker class implementing the interfaces (SOLID principles)
export default class MyWorker extends WorkerEntrypoint<Env> implements GreetingService, StringManipulationService {
  /**
   * A warm, friendly greeting from your new Workers MCP server.
   * @param name {string} the name of the person we are greeting.
   * @return {string} the contents of our greeting.
   */
  sayHello(name: string): string {
    return `Hello from an MCP Worker, ${name}!`
  }

  /**
   * Reverses the characters in a string.
   * @param input {string} the string to reverse.
   * @return {string} the reversed string.
   */
  reverseString(input: string): string {
    return input.split('').reverse().join('');
  }

  /**
   * @ignore
   **/
  async fetch(request: Request): Promise<Response> {
    // Use dependency injection (Dependency Inversion Principle)
    return new ProxyToSelf(this).fetch(request)
  }
}
```

### 3.3. Update the Environment Type Definition

Ensure `worker-configuration.d.ts` includes the SHARED_SECRET:

```typescript
// Generated by Wrangler
interface Env {
  SHARED_SECRET: string;
}
```

### 3.4. Verify the wrangler.jsonc file

Make sure your `wrangler.jsonc` is properly configured:

```jsonc
{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "mcp-postman",  // Your project name
  "main": "src/index.ts",
  "compatibility_date": "2025-03-13",
  "observability": {
    "enabled": true
  }
  // Other settings may be present
}
```

## 4. API Token Configuration

### 4.1. Creating the proper Cloudflare API token

1. Navigate to the Cloudflare Dashboard → Profile → API Tokens
2. Click "Create Token"
3. Either:
   - Select the "Edit Cloudflare Workers" template (recommended)
   - Create a custom token with the following permissions:

Required permissions:
- Account + Workers KV Storage = Edit
- Account + Workers Scripts = Edit
- Zone + Workers Routes = Edit
- Account + Account Settings = Read
- User + User Details = Read (critical)
- Account + Workers Tail = Read
- Account + Workers R2 Storage = Edit
- Account + Cloudflare Pages = Edit
- Account + Workers Builds Configuration = Edit

### 4.2. Set up the API token in your environment

```bash
# Export the token as an environment variable
export CLOUDFLARE_API_TOKEN=your_token_value_here
```

## 5. Deployment

### 5.1. Deploy your MCP server

```bash
# Run the deploy script
npm run deploy
```

This command:
- Generates documentation from your JSDoc comments
- Deploys your worker to Cloudflare's global network
- Sets up the necessary bindings

### 5.2. Verify the deployment

After successful deployment, you should see a URL like:
```
https://your-project-name.your-subdomain.workers.dev
```

Make note of this URL for the next steps.

## 6. Claude Desktop Integration

### 6.1. Automatic Integration

The `workers-mcp setup` command should handle integrating with Claude Desktop automatically during the setup process (Step 5). If prompted, provide a name for your MCP server in Claude.

### 6.2. Manual Integration (if automatic fails)

If automatic integration doesn't work, you can manually run:

```bash
npx workers-mcp run your-server-name https://your-project-name.your-subdomain.workers.dev .
```

Replace:
- `your-server-name` with a descriptive name for Claude to use
- Use the URL from your deployment
- The dot (`.`) refers to your current directory

### 6.3. Verify Configuration in Claude Desktop

The configuration is saved to:
```
~/Library/Application Support/Claude/claude_desktop_config.json
```

It should include an entry like:

```json
"your-server-name": {
  "command": "/path/to/node_modules/.bin/workers-mcp",
  "args": [
    "run",
    "your-server-name",
    "https://your-project-name.your-subdomain.workers.dev",
    "/path/to/your/project"
  ],
  "env": {}
}
```

## 7. Testing Your MCP Server

### 7.1. In Claude Desktop

1. Open Claude Desktop
2. Click the "+" button to start a new chat
3. Use the MCP tool by asking Claude to use it:
   - "Use [your-server-name] to sayHello to me"
   - "Use [your-server-name] to reverseString with input 'Hello World'"

### 7.2. Directly via HTTP (for debugging)

```bash
# Test the direct HTTP endpoint
curl https://your-project-name.your-subdomain.workers.dev
```

## 8. Extending Your MCP Server

### 8.1. Adding New Methods

Edit `src/index.ts` to add new methods to your `MyWorker` class:

```typescript
/**
 * Counts the number of words in a string.
 * @param text {string} the text to analyze.
 * @return {number} the word count.
 */
countWords(text: string): number {
  return text.split(/\s+/).filter(word => word.length > 0).length;
}
```

### 8.2. Follow SOLID Principles

- **Single Responsibility**: Each method should do one thing well
- **Open/Closed**: Extend functionality without modifying existing code
- **Liskov Substitution**: Subtypes should be substitutable for base types
- **Interface Segregation**: Group related methods in specific interfaces
- **Dependency Inversion**: Depend on abstractions, not implementations

### 8.3. Update Documentation

Always update your JSDoc comments when adding new methods, and regenerate documentation.

### 8.4. Redeploy

```bash
npm run deploy
```

## 9. Common Issues and Troubleshooting

### 9.1. API Token Permission Errors

**Issue**: `Authentication error [code: 10000]` or missing permissions
**Solution**: Ensure your API token has all required permissions, especially "User -> User Details -> Read"

### 9.2. Shared Secret Issues

**Issue**: Server rejects requests with authentication errors
**Solution**: Reupload your shared secret

```bash
npx workers-mcp secret upload
```

### 9.3. Claude Desktop Integration Failures

**Issue**: Claude can't find or use your MCP server
**Solution**: Verify the configuration file at `~/Library/Application Support/Claude/claude_desktop_config.json`

### 9.4. Deployment Failures

**Issue**: Worker fails to deploy
**Solution**: Check your `wrangler.jsonc` for syntax errors and ensure your API token has correct permissions

### 9.5. Method Not Found

**Issue**: Claude says it can't find your method
**Solution**: Ensure your method has proper JSDoc annotations and you've redeployed after adding it

## Conclusion

Following this guide, you should now have a fully functional MCP server deployed on Cloudflare Workers and integrated with Claude Desktop. You can extend it with additional methods to create powerful AI tool integrations.

For more information:
- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)
- [Model Context Protocol (MCP) Documentation](https://github.com/anthropics/model-context-protocol)
- [workers-mcp GitHub Repository](https://github.com/cloudflare/workers-mcp)

---

## How to Use This Guide

This guide serves as a reference for creating new MCP servers or troubleshooting existing ones. Keep it updated as you discover new techniques or encounter additional issues during development. 